{% extends "home/base.html" %}
{% load static %}
{% block title %}Deploy service{% endblock %}

{% block content %}

<style>
    /* T-Mobile Brand Colors */
    :root {
        --dt-magenta: #E20074;
        --dt-grey-1: #262626;
        --dt-grey-2: #4B4B4B;
        --dt-grey-3: #6c757d;
        --dt-light-grey: #f8f9fa;
    }

    /* Page styling */
    .page-title {
        font-weight: 700;
        color: var(--dt-magenta);
        border-bottom: 2px solid var(--dt-magenta);
        padding-bottom: 10px;
        margin-bottom: 25px;
    }

    /* Table styling */
    .services-table thead {
        background-color: var(--dt-magenta);
        color: white;
    }

    .services-table th {
        font-weight: 600;
        text-transform: uppercase;
        font-size: 0.9rem;
        border: none;
    }

    .services-table tbody tr:hover {
        background-color: rgba(226, 0, 116, 0.05);
        transition: 0.2s ease;
    }

    .services-table td {
        vertical-align: middle;
        font-size: 0.95rem;
    }

    /* Button styling */
    .btn-pop {
        background-color: var(--dt-magenta);
        border: none;
        font-weight: 600;
        padding: 5px 15px;
        border-radius: 4px;
        transition: background-color 0.2s;
    }

    .btn-pop:hover {
        background-color: #b0005a;
        /* Darker magenta */
    }

    /* Modal Styling */
    .modal-header {
        background-color: var(--dt-magenta);
        color: white;
        border-bottom: none;
    }

    .modal-title {
        font-weight: 700;
    }

    .btn-close-white {
        filter: invert(1) grayscale(100%) brightness(200%);
    }

    .server-room-card {
        background-color: #f9f9f9;
        border: 1px solid #ddd;
        border-radius: 8px;
        padding: 15px;
        height: 100%;
    }

    .server-room-title {
        color: var(--dt-magenta);
        font-weight: 700;
        border-bottom: 2px solid #ddd;
        padding-bottom: 8px;
        margin-bottom: 15px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .info-row {
        margin-bottom: 8px;
        font-size: 0.9rem;
        display: flex;
        justify-content: space-between;
        border-bottom: 1px dashed #eee;
        padding-bottom: 4px;
    }

    .info-label {
        font-weight: 600;
        color: var(--dt-grey-2);
    }

    .info-value {
        color: var(--dt-grey-1);
        text-align: right;
        font-family: inherit;
    }
</style>

<div class="container mt-5">

    <h2 class="page-title">Services Table</h2>

    <form method="get" class="row g-3 align-items-end mb-4 p-3 bg-light rounded shadow-sm">
        <div class="col-md-3">
            <label class="form-label fw-bold">Customer</label>
            <select name="operator" class="form-select">
                <option>All</option>
                {% for op in operators %}
                <option value="{{ op }}" {% if request.GET.operator == op %}selected{% endif %}>
                    {{ op }}
                </option>
                {% endfor %}
            </select>
        </div>
        <div class="col-md-3">
            <label class="form-label fw-bold">Location</label>
            <select name="location" class="form-select">
                <option>All</option>
                {% for loc in locations %}
                <option value="{{ loc }}" {% if request.GET.location == loc %}selected{% endif %}>
                <option value="{{ loc }}" {% if request.GET.location == loc %}selected{% endif %}>
                    {{ loc }}
                </option>
                {% endfor %}
            </select>
        </div>
        <div class="col-md-4">
            <label class="form-label fw-bold">Search</label>
            <input type="text" name="keyword" class="form-control" placeholder="Search by keyword..."
                value="{{ request.GET.keyword }}">
        </div>
        <div class="col-md-2">
            <button type="submit" class="btn btn-pop w-100 text-white">
                Filter
            </button>
        </div>
    </form>

    <div class="table-responsive shadow-sm rounded">
        <table class="table table-hover services-table mb-0">
            <thead>
                <tr>
                    <th>Service Id</th>
                    <th>Service Type</th>
                    <th>Customer</th>
                    <th>Location</th>
                    <th class="text-center" style="width: 100px;">Action</th>
                </tr>
            </thead>
            <tbody>
                {% for s in page_obj %}
                <tr>
                    <td><strong>{{ s.service_sign }}</strong></td>
                    <td>{{ s.service_type }}</td>
                    <td>{{ s.operator|upper }}</td>
                    <td>{{ s.location }}</td>
                    <td class="text-center">
                        <button
                            class="btn btn-sm btn-pop text-white"
                            onclick="showPopInfo({{ s.id }}, '{{ s.service_sign|escapejs }}')"
                        >
                            PoP
                        </button>
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="5" class="text-center py-4 text-muted">No services found matching your criteria.</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Retain existing pagination if any (not shown in original explicitly but good practice) -->

</div>

<!-- PoP Modal -->
<div class="modal fade" id="popModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="popModalLabel">Details Info</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                    aria-label="Close"></button>
            </div>
            <div class="modal-body bg-light">
                <div id="popContent" class="row g-4">
                    <!-- Content injected via JS -->
                </div>
                <div id="popLoading" class="text-center py-5" style="display:none;">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
                <div id="popError" class="alert alert-danger m-3" style="display:none;"></div>
            </div>
        </div>
    </div>
</div>


<script>
    function showPopInfo(id, serviceSign) {
        const modalEl = document.getElementById('popModal');
        const modalTitle = document.getElementById('popModalLabel');
        const contentDiv = document.getElementById('popContent');
        const loadingDiv = document.getElementById('popLoading');
        const errorDiv = document.getElementById('popError');

        // Set Title
        modalTitle.textContent = `PoP Info â€” ${serviceSign}`;

        // Reset State
        contentDiv.innerHTML = '';
        contentDiv.style.display = 'none';
        errorDiv.style.display = 'none';
        loadingDiv.style.display = 'block';

        // Show Modal immediately
        const modal = new bootstrap.Modal(modalEl);
        modal.show();

        fetch(`/services/api/pop-detail/${id}/`)
            .then(response => response.json())
            .then(data => {
                loadingDiv.style.display = 'none';

                if (data.error) {
                    errorDiv.textContent = data.error;
                    errorDiv.style.display = 'block';
                } else {
                    contentDiv.style.display = 'flex';
                    contentDiv.innerHTML = `
                <div class="col-md-6">
                    <div class="server-room-card">
                        <div class="server-room-title">Server Room 1</div>
                        <div class="info-row"><span class="info-label">Prostorija:</span> <span class="info-value">${data.server_room_1.prostorija || '-'}</span></div>
                        <div class="info-row"><span class="info-label">Rack 1:</span> <span class="info-value">${data.server_room_1.rack || '-'}</span></div>
                        <div class="info-row"><span class="info-label">ODF:</span> <span class="info-value">${data.server_room_1.odf || '-'}</span></div>
                        <div class="info-row"><span class="info-label">Pozicija:</span> <span class="info-value">${data.server_room_1.pozicija || '-'}</span></div>
                        <div class="info-row"><span class="info-label">End Customer EQ Info:</span> <span class="info-value">${data.server_room_1.end_customer_eq_info || '-'}</span></div>
                        <div class="info-row"><span class="info-label">End Customer INT Info:</span> <span class="info-value">${data.server_room_1.end_customer_int_info || '-'}</span></div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="server-room-card">
                        <div class="server-room-title">Server Room 2</div>
                        <div class="info-row"><span class="info-label">Prostorija:</span> <span class="info-value">${data.server_room_2.prostorija || '-'}</span></div>
                        <div class="info-row"><span class="info-label">Rack 1:</span> <span class="info-value">${data.server_room_2.rack || '-'}</span></div>
                        <div class="info-row"><span class="info-label">ODF:</span> <span class="info-value">${data.server_room_2.odf || '-'}</span></div>
                        <div class="info-row"><span class="info-label">Pozicija:</span> <span class="info-value">${data.server_room_2.pozicija || '-'}</span></div>
                        <div class="info-row"><span class="info-label">End Customer EQ Info:</span> <span class="info-value">${data.server_room_2.end_customer_eq_info || '-'}</span></div>
                        <div class="info-row"><span class="info-label">End Customer EQ INT Info:</span> <span class="info-value">${data.server_room_2.end_customer_int_info || '-'}</span></div>
                    </div>
                </div>
            `;
                }
            })
            .catch(err => {
                loadingDiv.style.display = 'none';
                errorDiv.textContent = "Failed to load data.";
                errorDiv.style.display = 'block';
                console.error(err);
            });
    }
</script>

{% endblock %}